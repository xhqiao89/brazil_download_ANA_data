import requests
from bs4 import BeautifulSoup
import datetime as dt
import csv

# today = dt.date.today()
# day = today.day
# first = today.replace(day=1)
# month = first - dt.timedelta(days=1)
# lastmonth = month.replace(day=day)

DataInicio = '01/01/2010'
DataFim = '01/07/2019'

cod_list=[2346446,24035000,24051000,24055000,26033600,58116900,58120000,58512030,60011005,60016000,60018500,60018800,60020500,60022000,60038100,60038200,60160080,60179000,60190000,60191000,60199000,60200600,60203000,60229000,60229500,60230080,60358080,60359080,60381001,60436350,60439500,60444850,60448000,60453000,60454000,60478480,60500000,60510100,60540000,60544990,60564000,60614000,60622100,60626000,60640000,60650000,60655500,60710800,60710900,60711010,60714000,60781000,60783000,60787000,60790001,60791000,60792000,60805100,60842001,60845500,60854900,60883000,60884000,60886000,60889000,60890000,60891000,60895500,60896000,60897000,60898000,60901000,60902000,60904000,60908000,60910100,60910200,60910300,60920500,60920700,60921600,60927000,60931000,60935000,60941000,60944500,60955000,60959500,60959600,60959800,60960800,60961050,60975000,61009001,61012001,61024001,61040000,61060001,61061080,61065090,61078600,61106800,61106900,61112000,61114500,61116000,61135002,61146080,61176000,61196000,61203000,61268700,61268800,61395100,61410000,61410000,61424900,61465500,61487000,61487080,61511000,61537000,61566000,61661010,61684000,61684500,61685000,61689000,61696000,61710000,61712000,61731000,61740040,61772000,61774200,61774600,61775000,61780800,61782100,61782800,61783100,61783445,61783450,61784400,61784500,61787000,61795100,61802502,61807002,61810800,61812000,61813000,61816500,61817004,61820000,61828000,61828500,61829700,61830000,61830000,61833000,61855000,61869700,61872200,61872600,61875000,61884090,61890800,61895020,61895050,61895075,61898500,61899000,61902000,61902000,61909100,61915005,61924950,61945080,61991000,61997000,62019700,62310100,62335000,62360060,62370100,62375000,62376000,62378900,62379050,62400600,62472800,62473200,62512080,62512092,62557000,62560000,62590000,62596150,62606000,62610000,62664500,62671200,62674000,62679000,62681000,62690500,62693000,62705000,62707500,62714000,62726800,62727500,62741000,62743000,62752000,62758000,62760044,62760800,62761000,62761250,62774000,62776450,62776580,62776780,62776800,62780700,62800000,62815200,62817900,62820020,62823000,62824000,62829200,62871000,62885600,62885700,63000050,63000100,63001080,63001100,63001117,63001120,63001125,63001130,63001223,63001225,63001230,63001260,63001263,63001560,63001603,63001605,63001608,63001635,63001638,63001642,63001650,63001675,63003200,63010000,63170100,63250700,63250800,63250850,63250900,63257000,63259000,63270000,63400000,63805000,63850000,63905000,63910000,63920080,63921000,63968000,63995090,64080000,64099000,64101000,64105800,64115000,64119000,64182000,64198000,64215080,64219200,64220050,64221500,64230230,64230300,64230400,64230450,64230600,64232000,64240200,64241200,64241300,64241500,64247000,64250010,64270080,64278500,64310000,64320010,64328050,64332080,64345075,64345080,64362001,64370000,64390000,64390000,64444000,64446999,64464995,64480995,64482000,64490800,64491000,64494000,64506000,64507000,64516080,64535080,64541000,64560000,64562000,64571080,64571080,64575001,64618500,64618500,64630100,64630500,64632000,64633050,64638000,64671600,64675002,64682000,64725000,64767000,64773500,64773750,64773890,64785000,64815000,64831000,64855000,64863100,64864100,64864200,64892500,64902080,65025000,65035001,65100001,65175001,65220001,65258000,65259000,65260001,65271000,65275000,65280000,65293000,65310001,65370001,65764001,65775901,65809000,65813100,65815050,65819300,65826720,65854500,65875500,65883051,65889700,65894991,65927001,65945200,65945600,65948000,65950200,65960001,65960001,65970001,65981500,65984000,65987000,65987000,65987001,65992500,65992500,65999200,65999463,66005100,66005400,66005600,66005900,66005960,66025500,66051000,66052500,66052900,66053200,66070004,66071380,66071382,66071385,66071392,66071397,66071470,66162000,66164600,66165000,66170100,66170600,66171400,66171500,66174000,66210000,66260001,66260110,66280000,66384000,66385500,66386000,66390090,66400325,66400360,66400390,66420160,66420250,66452500,66454800,66483600,66483800,66484500,66493000,66493900,66521000,66522000,66522100,66525100,66710000,66810000,66861000,66870000,66870000,66900000,66910000,66941000,66945000,66945000,67100000,70120000,70150000,70305000,70600000,70610000,70710000,70720000,70841500,70842000,70843000,70843500,70844200,71325000,71383300,71386500,71388600,71497000,71540000,71620450,71645000,71647000,71655000,71700000,71740000,72080000,72101100,72428000,72430050,72500000,72806000,72810000,72849000,72849000,72860000,72860080,72870900,72880000,73170000,73200080,73200500,73220000,73250000,73251000,73290000,73310000,73331800,73331850,73335000,73389000,73390000,73437000,73440000,73445000,73460000,73528000,73552000,73553000,73560000,73570000,73582500,73600600,73600700,73675000,73690002,73691000,73692100,73693500,73693800,73698500,73712000,73892000,74050000,74100000,74100000,74100000,74130000,74315000,74322000,74324000,74329000,74350100,74356000,74462000,74463000,74465000,74467000,74468500,74550000,74660000,74690100,74695000,75050000,75181000,75187000,75188000,75288100,75290000,75305000,75307000,75318000,75326000,75331000,75343000,75344000,80360200,80360400,81019000,82335000,82500000,83029900,85029000,86100600,86110000,86163000,86406000]

i=0

gages_number = len(cod_list)

while i < gages_number:

    url = 'http://telemetriaws1.ana.gov.br/ServiceANA.asmx/DadosHidrometeorologicos?codEstacao=' + str(cod_list[i]) + '&DataInicio=' + DataInicio + '&DataFim=' + DataFim

    response = requests.get(url)

    try:
        soup = BeautifulSoup(response.content, "xml")

        times = soup.find_all('DataHora')
        values = soup.find_all('Vazao')

        dates = []
        flows = []

        for time in times:
            dates.append(dt.datetime.strptime(time.get_text().strip(), "%Y-%m-%d %H:%M:%S"))

        for value in values:
            flows.append(value.get_text().strip())

        flows_new= flows[::-1]
        dates_new = dates[::-1]

        csv_path = '/home/sherry/Brazil_historical_data/Short/{filename}.csv'.format(filename=str(cod_list[i]))
        csv_file = open(csv_path, 'wb')
        f = csv.writer(csv_file)
        j = 0
        flows_number = len(flows)
        while j < flows_number:
            flow_date_array = [dates_new[j], flows_new[j]]
            f.writerow(flow_date_array)
            j += 1
        csv_file.close()

        print(str(cod_list[i]) + "success")

    except:

        print(str(cod_list[i]) + "error")

    i+=1

print("!!!!!!!!!!!!!!!!!FINISHED!!!!!!!!!!!!!!!")